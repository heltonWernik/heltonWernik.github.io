---
layout: post
title: SQL Injection Conhecendo e protegendo
date: '2018-01-13T12:42:00.001-08:00'
author: Israel Helton Wernik
tags: 
modified_time: '2018-01-13T12:44:08.799-08:00'
thumbnail: https://lh5.googleusercontent.com/3e0Xdp4Mrdld91slZ7cLULYwwV0XpndKyLp0LlNArt7HnZ4KEeimQRvBjO4xXBrgQWJMUBhnrwJeLaaVfSw2dOihg71l9QFA6e8LCWQksHhBN4B8i24tO6aEtouG8cKiKtM4tIA_=s72-c
blogger_id: tag:blogger.com,1999:blog-5213248075369348047.post-5484878723476102065
blogger_orig_url: https://cibersegurancawernik.blogspot.com/2018/01/sql-injection-conhecendo-e-protegendo.html
---

<div dir="ltr" style="line-height: 1.38; margin-bottom: 3pt; margin-top: 0pt;"><br /></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="291" src="https://lh5.googleusercontent.com/3e0Xdp4Mrdld91slZ7cLULYwwV0XpndKyLp0LlNArt7HnZ4KEeimQRvBjO4xXBrgQWJMUBhnrwJeLaaVfSw2dOihg71l9QFA6e8LCWQksHhBN4B8i24tO6aEtouG8cKiKtM4tIA_" style="border: none; transform: rotate(0rad);" width="602" /></span></div><br />Nesse tutorial vamos entender o básico do SQL injection, como funciona e como consertar essa vulnerabilidade, depois&nbsp;<span style="font-family: arial; font-size: 14.6667px; white-space: pre-wrap;">faremos outro post demonstrando técnicas mais avançadas de injeção de SQL e como atravessar as barreiras de segurança. </span><br /><span style="font-family: arial; font-size: 14.6667px; white-space: pre-wrap;"><br /></span>Para isso v<span style="font-family: arial; font-size: 11pt; white-space: pre-wrap;">amos entrar em um portal vulnerável com uma senha errada e ver o que o log nos diz:</span><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Tentaremos entrar com o Login de Alice, alguém que tem login e senha, porém não sabemos a senha dela.</span></div><br /><a name='more'></a><br /><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Vamos começar com o email dela </span><a href="mailto:alice@bank.com" style="text-decoration-line: none;"><span style="color: #1155cc; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">alice@bank.com</span></a><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> e a senha alice123</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="276" src="https://lh4.googleusercontent.com/7-h_eptigWUzYP7gpVMzhCKcLhkFdORWUxnt0xiIhDgLioFxgcOYlMudQuhuu2_c0rFQ7NFIwQXg0JmC7O26Iu9mKfKZimzsRumMQSnx_Ma9d53EUvYYB6PhYv0lKQ13QzXEzWss" style="border: none; transform: rotate(0rad);" width="394" /></span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Esse é o resultado do LOG</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="background-color: black; color: #2ecc71; font-family: &quot;verdana&quot;; font-size: 9pt; vertical-align: baseline; white-space: pre-wrap;"> &nbsp;[1m[35mUser Load (0.3ms)[0m &nbsp;SELECT &nbsp;`users`.* FROM `users` &nbsp;WHERE (email = 'alice@bank.com' AND password_hash = 'alice123') &nbsp;ORDER BY `users`.`id` ASC LIMIT 1</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Então, a senha alice123 não parece funcionar para a conta de Alice. Agora vamos tentar inserir a mesma senha seguido do caractere de uma única aspa '.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Inserimos:</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Nome de usuário: alice@bank.com</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Senha: alice123'</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Resultado</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> </span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="317" src="https://lh4.googleusercontent.com/3UFijMGu5nGmXQjlLW9fTXLno05kMhV5bMdc4wV-C7Kc_MyLIu5JbJNdA7yV1wgJhC8p9oxT4DN272L_93pYZmXSIHmXv4sUcohd8l-YcDxR1bXWdtydizf2IKc0LfzQpZ8Z2Y74" style="border: none; transform: rotate(0rad);" width="602" /></span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Algo quebrou. Adicionar a aspa única à senha causou a falha no aplicativo TradePORTAL com um erro de servidor interno HTTP 500</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Olhando para o painel de log, parece ter sido devido ao erro de sintaxe SQL</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Vamos ler com cuidado a saída do log de erro. vemos que a aspa única ' na senha de Alice causou esse erro</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #2ecc71; font-family: &quot;arial&quot;; font-size: 9pt; vertical-align: baseline; white-space: pre-wrap;">[1m[36mUser Load (0.6ms)[0m &nbsp;[1mSELECT &nbsp;`users`.* FROM `users` &nbsp;WHERE (email = 'alice@bank.com' AND password_hash = 'alice123'') &nbsp;ORDER BY `users`.`id` ASC LIMIT 1[0m</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #e74c3c; font-family: &quot;arial&quot;; font-size: 9pt; vertical-align: baseline; white-space: pre-wrap;">Mysql2::Error: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''alice123'') &nbsp;ORDER BY `users`.`id` ASC LIMIT 1' at line 1: SELECT &nbsp;`users`.* FROM `users` &nbsp;WHERE (email = 'alice@bank.com' AND password_hash = 'alice123'') &nbsp;ORDER BY `users`.`id` ASC LIMIT 1</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 16pt; margin-top: 0pt;"><span style="color: #666666; font-family: &quot;arial&quot;; font-size: 15pt; vertical-align: baseline; white-space: pre-wrap;">Entendendo o erro </span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Para entender por que o erro ocorreu, vamos primeiro analisar o método de autenticação do TradePORTAL, especificamente o código responsável por verificar as credenciais de autenticação de Alice.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="173" src="https://lh6.googleusercontent.com/G_EHyvtV8OoXMAaQCiJZM5dxOaTz0W3U7KL0yi-ogBBQjktrGx-YdK3AIbCav2RxhDF1xgfSXrd3mT7ir3pUSdO0-pkuEADzQJYiOc_7SihpJ62_jBolTFZkDPYb2INl73lCXMqu" style="border: none; transform: rotate(0rad);" width="602" /></span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Linha 1. &nbsp;</span><span style="color: #777777; font-family: &quot;arial&quot;; font-size: 10pt; vertical-align: baseline; white-space: pre-wrap;">&nbsp;$email=$_POST['email'];</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Para validar as credenciais do usuário, o elemento de array </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">_POST []</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> que contém o endereço de e-mail (passado no request </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">POST</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">) é atribuído à variável local </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$email</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Linha 2. &nbsp;&nbsp;&nbsp;</span><span style="color: #777777; font-family: &quot;arial&quot;; font-size: 10pt; vertical-align: baseline; white-space: pre-wrap;">$password=$_POST['password'];</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Da mesma forma, o valor da senha enviada da Alice é extraído da Array </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">_POST []</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> e atribuído à senha local </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$password</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">linha 3. &nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #777777; font-family: &quot;arial&quot;; font-size: 10pt; vertical-align: baseline; white-space: pre-wrap;">$stmt=mysql_query("SELECT * FROM users WHERE (email='$email' AND password='$password') LIMIT 0,1");</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">A variável string </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$stmt</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> é então declarada, que representa a consulta SQL usada para autenticar as credenciais de Alice.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Observe que os valores de </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$email</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> e </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$password</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> da Alice são concatenados para criar a query final.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Linha 4. &nbsp;&nbsp;</span><span style="color: #777777; font-family: &quot;arial&quot;; font-size: 10pt; vertical-align: baseline; white-space: pre-wrap;">$count = mysql_fetch_array($stmt);</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">A SQL query definida na variável string </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$stmt</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> &nbsp;é então executada invocando o método </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">mysql_fetch_array</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">. Este método executa nossa consulta ao servidor backend SQL &nbsp;que é verificado na linha 8 através do bloco if/else.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Finalmente, se as credenciais de Alice coincidirem, o método </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">session_start()</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> é chamado e ela é redirecionada para sua página de perfil.</span></div><br /><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Para entender melhor como a entrada de Alice é usada para construir a instrução SQL usada para autenticação, vamos simplificar o código-fonte de autenticação para o aplicativo TradePORTAL e ver o que acontece.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="168" src="https://lh4.googleusercontent.com/AOLTFnkWzcW2sDPrXbRTyS1P_jNfQ-lXoHSIDPqViQyfljqEiCpaxz45CL5tVhLZPsXEuCoViRfU0flMrfvQYKScpG2D2G5de5fhNv0IA1V2cmMy6fI7FJ8fx-ugWw20flCfdGIp" style="border: none; transform: rotate(0rad);" width="602" /></span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Agora que simplificamos nosso código de lógica de autenticação, vamos analisar a consulta SQL gerada pelo TradePORTAL para validar as credenciais de autenticação de Alice.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Voltando ao aplicativo vamos seguir os seguintes passos:</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">Passo 1:</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> Digite a senha alice123' e veja o que acontece ao código.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Observe como a aspa única ' que anexamos é interpretada pelo servidor SQL como um delimitador de string.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">No entanto, quando a consulta é processada, a última citação não possui um caractere de fechamento/correspondência, o que causa um erro de sintaxe SQL, resultando no erro de servidor interno HTTP 500</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="32" src="https://lh3.googleusercontent.com/_-MubiD41PGQqIa-buhSkrFBPvfc9wPi2wY46gIAoyyySYO7iji5DjWv_5tnIWvZoqhHV_5Qqe6gHTCyv7hToOLfrEOEEgtmlZocd8j1ut0F-GBZYu3Z8M4BPsNyuqntFEcC32r8" style="border: none; transform: rotate(0rad);" width="602" /></span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="184" src="https://lh6.googleusercontent.com/yT__zrWNiO4IgGxYDT6V2YlPwWJ82o8RaX0vftL2a7nI79Ifxi-jxyrIH4fi5KYjOM0hrPQk2PALakxJoaS5bS5LVwX4BDquwvXD3Z6SG0gzMidoKLh-grrTP_0dVdozMKKcrOyw" style="border: none; transform: rotate(0rad);" width="388" /></span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">Passo 2:</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> Agora vamos tentar iniciar sessão com uma senha seguida por duas aspas simples. por exemplo. alice123''</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Curiosamente, o aplicativo não apresenta um erro neste caso, pois o delimitador de string possui um fechamento</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="25" src="https://lh4.googleusercontent.com/eIUnUi_fozkafLLgqwOCi8rV31kTwNyMTMhCNce7I5Xb1m8nVH1bGs-cnsY6ksRYq0B6FpOvMHRz7z2SBT_o2yOI9UW6OcJrGA6gP3Ot1X0Bx6GOVAJZRvejmk56VB-Hz7weH6Tc" style="border: none; transform: rotate(0rad);" width="602" /></span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 16pt; margin-top: 0pt;"><span style="color: #666666; font-family: &quot;arial&quot;; font-size: 15pt; vertical-align: baseline; white-space: pre-wrap;">Ultrapassando a autenticação </span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Neste ponto, sabemos que a injeção de caracteres interpretados pelo servidor de banco de dados é conhecida como SQL Injection</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">No entanto, não são apenas as aspas únicas ' caracteres que podem ser injetados, Strings inteiras podem ser injetadas. E se isso pudesse ser usado para alterar completamente a finalidade da instrução SQL?</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Vamos tentar digitar as seguintes credenciais:</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Nome de usuário: alice@bank.com</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Senha: </span><span style="font-family: &quot;arial&quot;; font-size: 11pt; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;">' or 1=1) #</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Note que no MySQL o caractere # é usado para comentários de código. Fique atento ao código, tudo à direita do caractere # é um comentário .</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="252" src="https://lh5.googleusercontent.com/N6p4TWhE--sJPW0ke-f40o7uFHAJ18NXmvsnk4YRwPcJpJiTjk-e6GjEJP-0OLEbLrmjCBmnPQszXWTSJBoBEwBKn9XetlGSdCKgXeGKntLmOs6GG3kmXi2NNUCQNpfUdZVxKUgJ" style="border: none; transform: rotate(0rad);" width="362" /></span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="27" src="https://lh4.googleusercontent.com/wVNWFVzqi8au8QIie6B8MBWm-lVW1Vod-871s0Cjk5zBhHNbIq_ybG11u5NwCo1ublIeZKl2oDEWWxyCsJId5Tl-__6coQazcOhAkADnJBZ8Fd0ydtWmGAtEjuTEYUN_DrpoLKAs" style="border: none; transform: rotate(0rad);" width="602" /></span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Dessa forma passamos pelas credenciais sem problemas, mas porque?</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Lembre-se de que as seguintes entradas foram enviadas:</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Nome de usuário: alice@bank.com</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Senha: 'ou 1 = 1) #</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">O resultado acima resultou na seguinte instrução SQL:</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">SELECT *</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">WHERE (email = 'alice@bank.com'</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">AND password = ' ' OR 1 = 1) #</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Como a declaração é sintaticamente válida e OR 1 = 1 sempre retorna true, o mecanismo de autenticação foi ignorado. Vamos agora analisar a vulnerabilidade a partir de uma perspectiva de código.</span></div><br /><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Para recapitular rapidamente, os elementos da array </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">_POST[]</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> são extraídos do nome de usuário e senha da Alice), que são atribuídos às variáveis </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$email</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> e </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$password</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> locais.</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">A variável string </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$stmt</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> é então declarada, que representa a consulta SQL usada para autenticar as credenciais de Alice.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Observe que a entrada de $email e $password de Alice (recuperada usando a array _POST[] são concatenadas dentro da variável $stmt, sem verificações de validação de entrada.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Como não há validação de entrada (ou seja, não há verificação de caracteres permitidos, tamanho maximo ou minimo de strings ou remoção de caracteres "maliciosos", Alice tem a capacidade de injetar sintaxe SQL bruta nos campos de entrada de nome de usuário e senha para alterar o significado do consulta SQL responsável pela autenticação, resultando em um bypass do mecanismo de autenticação do aplicativo ... um ataque de Injeção SQL!</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 16pt; margin-top: 0pt;"><span style="color: #666666; font-family: &quot;arial&quot;; font-size: 15pt; vertical-align: baseline; white-space: pre-wrap;">Corrigindo</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Prepared statements, Declarações preparadas (também conhecidas como aka parameterized queries) são o melhor mecanismo para prevenir ataques de injeção SQL.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">As declarações preparadas são usadas para abstrair a sintaxe da instrução SQL dos parâmetros de entrada. Os modelos de declaração são primeiro definidos na camada do aplicativo, e os parâmetros são passados para eles.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">No PHP, isso pode ser efetuado usando um prepare method para enviar instruções SQL no banco de dados do backend.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Além de uma melhor postura de segurança contra ataques de injeção SQL, as declarações preparadas oferecem qualidade de código, desde uma perspectiva de legibilidade e manutenção, devido à separação da lógica SQL de suas entradas(inputs).</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Vamos ver o código antes do reparo</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="167" src="https://lh6.googleusercontent.com/4lJY-cxFL1ApWdKFdkkh9lFWx0JFQjujjP4WLqgssaxJpE98qCQGoJV3hGjT3irnwEp_jMqz0Nk05uJNBeznF7Cv7nLAuNC8rFadonzZrSGiLT264NulISyNMn5XTBNtqlDhM7CL" style="border: none; transform: rotate(0rad);" width="602" /></span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">E depois</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><img height="216" src="https://lh5.googleusercontent.com/nkx7DuW0dNI5O4XAsw2rzwPHwe-Bfw26mjWJLJ6TFZg7JErQrsbkR29vjZtXAaDBYvcsB1jlOV3WS-J96A2XMApiWruO2Mi6Y1I92klN0Uv-uXAWWfPcshANb3TgiRfjyeFOeteP" style="border: none; transform: rotate(0rad);" width="602" /></span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$email=$_POST['email'];</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$password=$_POST['password'];</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">//$stmt=mysql_query("SELECT * FROM users WHERE (email='$email' AND password='$password') LIMIT 0,1");</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$stmt = $db-&gt;prepare("SELECT * FROM users WHERE (email=:email AND password=:password) LIMIT 0,1");</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$stmt-&gt;bindParam(':email', $email);</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$stmt-&gt;bindParam(':password', $password);</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$stmt-&gt;execute();</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$count = $stmt-&gt;rowCount();</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">//$count = mysql_fetch_array($stmt);</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">if($count &gt; 0)</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">{</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">session_start();</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"># Successfully logged in and redirect to user profile page</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">}</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">else</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">{</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"># Auth failure - Redirect to Login Page</span></div><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">}</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Em nosso exemplo de código modificado, primeiro declaramos a string de consulta de autenticação e passamos isso para </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">prepare</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> method do PHP. </span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Observe que a variável </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$e-mail</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> e </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$password</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> agora foi substituída por </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">:e-mail</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> e </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">:password </span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">símbolo que atua como um espaço reservado para o método PHP bind_Param na linha 6 e 7.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">O método </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">bindParam()</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> é então chamado para passar o valor do parâmetro $email para a nossa declaração preparada. Esta função leva dois argumentos, o índice de posição do nosso espaço reservado indicado por </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">:email</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> e o valor do parâmetro armazenado na variável </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$e-mail</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Da mesma forma, o método </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">bindParam()</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> é então chamado para passar o valor do parâmetro </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">$password</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> para a nossa declaração preparada.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">Finalmente, executamos nossa consulta de autenticação invocando o método </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">execute().</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> O SQL usado pelo </span><span style="color: red; font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;">prepare()</span><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"> é pré compilado garantindo que todos os parâmetros enviados ao banco de dados sejam tratados como valores literais e não instrução SQL/query, garantindo que nenhum código SQL possa ser injetado.</span></div><br /><div dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><br /></div><div><span style="font-family: &quot;arial&quot;; font-size: 11pt; vertical-align: baseline; white-space: pre-wrap;"><br /></span></div>